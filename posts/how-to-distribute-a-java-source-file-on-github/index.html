<!doctype html><html lang=en><head><meta charset=utf-8><meta name=description content="Personal website of Roman Böhm. Includes blog posts, shorter 'Today I learned' posts, and various personal information."><meta name=viewport content="width=device-width,initial-scale=1"><link href=/css/stylesheet.css rel=stylesheet><title>Roman Böhm - How to: Distribute a Java Source File on GitHub</title></head><body><h1>Roman Böhm</h1><nav><ul class=menu><li><a href=/>Home</a></li><li><a href=/posts/>Posts</a></li><li><a href=/til/>TIL</a></li><li><a href=/tags/>Tags</a></li><li><a href=/about/>About</a></li><li><a href=/index.xml><img src=/images/rss.svg alt="RSS icon" width=14em></a></li></ul></nav><hr><h1>How to: Distribute a Java Source File on GitHub</h1><h2>2023-01-08</h2><b><a href=/tags/github>github</a></b>
<b><a href=/tags/distribution>distribution</a></b>
<b><a href=/tags/release>release</a></b><aside><nav id=TableOfContents><ul><li><a href=#update-2023-04-18>Update 2023-04-18</a></li><li><a href=#introduction>Introduction</a></li><li><a href=#the-source-file-to-be-distributed>The Source File To-be-distributed</a><ul><li><a href=#exec-maven-plugin>Exec Maven Plugin</a></li><li><a href=#preparereleasejava>PrepareRelease.java</a></li></ul></li><li><a href=#creating-a-release>Creating a Release</a></li><li><a href=#next-step>Next Step</a></li></ul></nav></aside><h2 id=update-2023-04-18>Update 2023-04-18</h2><p>The below post is relevant anymore only for historic reasons. Contrary to my statement below, JReleaser does indeed offer the possibility to <a href=https://fosstodon.org/@jreleaser/109676555681811519>distribute source files</a>, basically in a <a href=https://github.com/romanboehm/jsonwheel/blob/main/pom.xml#L170>single line</a>. In combination with the Maven Release plugin, I was able to standardize the whole workflow, which made distributing <code>JsonWheel.java</code> and upgrading versions much easier.</p><h2 id=introduction>Introduction</h2><p>For my single-source-file-no-dependencies JSON parser for the JVM, <a href=https://github.com/romanboehm/jsonwheel>JSON Wheel</a>, I was looking for a better way for distribution other than a bunch of convoluted, homegrown shell scripts, or modifying and uploading files manually to GitHub releases. With a release cadence of like one-and-a-half releases a year, who has time for that?</p><p>It should be done the proper way: More Java, more enterprise, more YAML, stuff happening automatically in CI, no manual work. Now, with for anything <em>but</em> a source distribution, I&rsquo;d fumble around with the apparently great <a href=https://jreleaser.org>JReleaser</a> (haven&rsquo;t tried it yet). This one currently doesn&rsquo;t offer distributing plain source files, however. So I set out to do that myself.</p><h2 id=the-source-file-to-be-distributed>The Source File To-be-distributed</h2><p>Firstly, I needed a way to prepare <code>src/main/java/com/romanboehm/jsonwheel/JsonWheel</code> for release, which contains of removing the package declaration. In my mind, that step is part of Maven&rsquo;s <code>package</code> phase and should be able to be run locally. Since there&rsquo;s no maven plugin for handling source-distributions &ndash; and I mean actually distributing a source file only, not distributing a sources jar &ndash;, I used the <a href=https://www.mojohaus.org/exec-maven-plugin/>Exec Maven Plugin</a> in combination with the small utility program <code>PrepareRelease.java</code>.</p><h3 id=exec-maven-plugin>Exec Maven Plugin</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#f92672>&lt;build&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;plugins&gt;</span>
</span></span><span style=display:flex><span>        ...
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;plugin&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;groupId&gt;</span>org.codehaus.mojo<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;artifactId&gt;</span>exec-maven-plugin<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;version&gt;</span>${exec-maven-plugin.version}<span style=color:#f92672>&lt;/version&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;executions&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>&lt;execution&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&lt;phase&gt;</span>package<span style=color:#f92672>&lt;/phase&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&lt;goals&gt;</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>&lt;goal&gt;</span>exec<span style=color:#f92672>&lt;/goal&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&lt;/goals&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>&lt;/execution&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;/executions&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;configuration&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>&lt;executable&gt;</span>java<span style=color:#f92672>&lt;/executable&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>&lt;arguments&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&lt;argument&gt;</span>PrepareRelease.java<span style=color:#f92672>&lt;/argument&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>&lt;/arguments&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;/configuration&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;/plugin&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/plugins&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/build&gt;</span>
</span></span></code></pre></div><p>Here, we bind the <code>exec</code> goal of the plugin to the <code>package</code> phase to run <code>PrepareRelease.java</code>.</p><h3 id=preparereleasejava>PrepareRelease.java</h3><p>This small Java script (heh) creates a copy of JsonWheel.java without the original package declaration, so one can insert the source code without any namespace conflicts.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>import</span> java.io.IOException<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.nio.file.Files<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.nio.file.Path<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.nio.file.StandardOpenOption<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>PrepareRelease</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> Path DEST <span style=color:#f92672>=</span> Path<span style=color:#f92672>.</span><span style=color:#a6e22e>of</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;target/distribution&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> Path SRC <span style=color:#f92672>=</span> Path<span style=color:#f92672>.</span><span style=color:#a6e22e>of</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;src/main/java/com/romanboehm/jsonwheel&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span><span style=color:#f92672>(</span>String<span style=color:#f92672>[]</span> args<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        var withoutPackageDecl <span style=color:#f92672>=</span> Files<span style=color:#f92672>.</span><span style=color:#a6e22e>readAllLines</span><span style=color:#f92672>(</span>SRC<span style=color:#f92672>.</span><span style=color:#a6e22e>resolve</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;JsonWheel.java&#34;</span><span style=color:#f92672>)).</span><span style=color:#a6e22e>stream</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>.</span><span style=color:#a6e22e>skip</span><span style=color:#f92672>(</span><span style=color:#ae81ff>2</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>.</span><span style=color:#a6e22e>toList</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        Files<span style=color:#f92672>.</span><span style=color:#a6e22e>createDirectories</span><span style=color:#f92672>(</span>DEST<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        Files<span style=color:#f92672>.</span><span style=color:#a6e22e>write</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>                DEST<span style=color:#f92672>.</span><span style=color:#a6e22e>resolve</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;JsonWheel.java&#34;</span><span style=color:#f92672>),</span>
</span></span><span style=display:flex><span>                withoutPackageDecl<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                StandardOpenOption<span style=color:#f92672>.</span><span style=color:#a6e22e>CREATE</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>As a result, we now provide the source file we want to upload later under <code>target/distribution/JsonWheel.java</code>.</p><h2 id=creating-a-release>Creating a Release</h2><p>GitHub actions does the heavy lifting here:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>name</span>: <span style=color:#ae81ff>build and release</span>
</span></span><span style=display:flex><span><span style=color:#f92672>on</span>: [<span style=color:#ae81ff>push]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>jobs</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>build</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>runs-on</span>: <span style=color:#ae81ff>ubuntu-latest</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>steps</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>checkout</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>uses</span>: <span style=color:#ae81ff>actions/checkout@v3</span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>set up JDK 17</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>uses</span>: <span style=color:#ae81ff>actions/setup-java@v3</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>with</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>java-version</span>: <span style=color:#e6db74>&#39;17&#39;</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>distribution</span>: <span style=color:#e6db74>&#39;adopt&#39;</span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>build with Maven</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>run</span>: <span style=color:#ae81ff>./mvnw --batch-mode package</span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>upload source distribution</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>if</span>: <span style=color:#ae81ff>startsWith(github.ref, &#39;refs/tags/&#39;)</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>uses</span>: <span style=color:#ae81ff>actions/upload-artifact@v3</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>with</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>name</span>: <span style=color:#ae81ff>source-distribution</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>path</span>: <span style=color:#ae81ff>target/distribution/JsonWheel.java</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>release</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>if</span>: <span style=color:#ae81ff>startsWith(github.ref, &#39;refs/tags/&#39;)</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>needs</span>: <span style=color:#ae81ff>build</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>runs-on</span>: <span style=color:#ae81ff>ubuntu-latest</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>steps</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>download source distribution</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>id</span>: <span style=color:#ae81ff>download-source-distribution</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>uses</span>: <span style=color:#ae81ff>actions/download-artifact@v3</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>with</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>name</span>: <span style=color:#ae81ff>source-distribution</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>path</span>: <span style=color:#ae81ff>JsonWheel.java</span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Release source file</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>uses</span>: <span style=color:#ae81ff>softprops/action-gh-release@v1</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>with</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>files</span>: <span style=color:#ae81ff>${{steps.download-source-distribution.outputs.download-path}}/JsonWheel.java</span>
</span></span></code></pre></div><p>The <code>build</code> job will be run on every push, not only for tag refs. It compiles, tests, and packages the application. As we noted above, <code>package</code> will also provide <code>target/distribution/JsonWheel.java</code> <em>if we have a tag ref</em>. This is the artifact we want to upload for usage in other jobs.</p><p><code>release</code> is the job which is actually concerned with providing the proper GitHub release. It will only run if the detected ref is a tag, e.g. <code>1.3.1</code> and only after <code>build</code> has finished.</p><p>When it does run, it downloads the previously uploaded file and hands it over to the release step, provided by <code>softprops/action-gh-release</code>. Note the file path for <code>with.files</code>: The <code>download-source-distribution</code> part in the variable&rsquo;s name references has to match the download step&rsquo;s <code>id</code>.</p><p>The <code>action-gh-release</code> (<a href=https://github.com/softprops/action-gh-release/>GitHub</a>) then takes care of creating a release, converting the commit messages to a changelog and placing the source file there.</p><p><img src=release.png alt="GitHub&rsquo;s release page for JSON Wheel showing release 1.3.1"></p><h2 id=next-step>Next Step</h2><p>Currently, I maintain the project version through both the pom.xml file&rsquo;s <code>project.version</code> property and git tags, which isn&rsquo;t great. When I feel like this causes too many headaches, I might revisit this issue, maybe even create a proper GitHub issue for it.</p><hr>© Roman Böhm 2021 - 2023 &ndash; <a href=https://github.com/romanboehm>Github</a> &ndash;
<a rel=me href=https://mastodon.social/@romanboehm>Mastodon</a> &ndash; <a href=https://www.linkedin.com/in/%F0%9F%96%A5%EF%B8%8F-roman-b%C3%B6hm-837946175/>LinkedIn</a></body></html>