<!doctype html><html lang=en><head><meta charset=utf-8><meta name=description content="Personal website of Roman Böhm. Includes blog posts, shorter 'Today I learned' posts, and various personal information."><meta name=viewport content="width=device-width,initial-scale=1"><link href=/css/stylesheet.css rel=stylesheet><title>Roman Böhm - How to: Configure Multiple DataSources in Spring Boot</title></head><body><h1>Roman Böhm</h1><nav><ul class=menu><li><a href=/>Home</a></li><li><a href=/posts/>Posts</a></li><li><a href=/til/>TIL</a></li><li><a href=/tags/>Tags</a></li><li><a href=/about/>About</a></li><li><a href=/index.xml><img src=/images/rss.svg alt="RSS icon" width=14em></a></li></ul></nav><hr><h1>How to: Configure Multiple DataSources in Spring Boot</h1><h2>2022-08-16</h2><h4>Last edit: 2023-06-02</h4><b><a href=/tags/spring-boot>spring-boot</a></b>
<b><a href=/tags/spring>spring</a></b>
<b><a href=/tags/hikari>hikari</a></b><aside><nav id=TableOfContents><ul><li><a href=#introduction>Introduction</a></li><li><a href=#solutions>Solutions</a><ul><li><a href=#validation>Validation</a></li><li><a href=#solution-a-making-use-of-hikariconfig>Solution A: Making use of <code>HikariConfig</code></a></li><li><a href=#solution-b-i-using-yaml-anchors>Solution B I: Using YAML anchors</a></li><li><a href=#solution-b-ii-using-yaml-anchors>Solution B II: Using YAML anchors</a></li></ul></li><li><a href=#evaluation>Evaluation</a></li></ul></nav></aside><h2 id=introduction>Introduction</h2><p>A few days ago a colleague of mine and I wanted to know &ldquo;[w]hat’s the Spring Boot way of defining three different DataSources through externalized config (application.yaml), with each sharing the same Hikari settings?&rdquo; That is: We basically had a working solution, we just weren&rsquo;t sure it was how you&rsquo;d do it making use of all the goodness Spring Boot offers. Therefore I consequently tried <a href="https://twitter.com/0xromanboehm/status/1557374298536525825?s=20&amp;t=09VLy1imZC-GJ5BtLaH7Cw">offloading the task of figuring it out to Twitter</a>. -.-</p><p>And &mldr; it worked! Thanks to <a href="https://twitter.com/rotnroll666/status/1557377897693945856?s=20&amp;t=09VLy1imZC-GJ5BtLaH7Cw">Michael Simons&rsquo; hint</a>, and the always excellent <a href=https://docs.spring.io/spring-boot/docs/current/reference/html/howto.html#howto.data-access.configure-two-datasources>docs.spring.io resource</a> we knew we were right on track. We just had to <a href="https://twitter.com/dreadwarrior/status/1557407059922112514?s=20&amp;t=09VLy1imZC-GJ5BtLaH7Cw">iron out some wrinkles</a>.</p><h2 id=solutions>Solutions</h2><p>I created a demo to figure out and validate the solutions. You can find it on <a href=https://github.com/romanboehm/multiple-datasources>GitHub</a>.</p><h3 id=validation>Validation</h3><p>Last things first, this is the test that any solution would have to pass:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@SpringBootTest</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Testcontainers</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MultipleDatasourcesApplicationTests</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Container</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>static</span> PostgreSQLContainer<span style=color:#f92672>&lt;?&gt;</span> databaseOne <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> PostgreSQLContainer<span style=color:#f92672>&lt;&gt;</span>(<span style=color:#e6db74>&#34;postgres:latest&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Container</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>static</span> PostgreSQLContainer<span style=color:#f92672>&lt;?&gt;</span> databaseTwo <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> PostgreSQLContainer<span style=color:#f92672>&lt;&gt;</span>(<span style=color:#e6db74>&#34;postgres:latest&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@DynamicPropertySource</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>loadDatabaseProperties</span>(DynamicPropertyRegistry registry) {
</span></span><span style=display:flex><span>		registry.<span style=color:#a6e22e>add</span>(<span style=color:#e6db74>&#34;datasources.datasource-one.url&#34;</span>, databaseOne::getJdbcUrl);
</span></span><span style=display:flex><span>		registry.<span style=color:#a6e22e>add</span>(<span style=color:#e6db74>&#34;datasources.datasource-one.jdbcUrl&#34;</span>, databaseOne::getJdbcUrl); <span style=color:#75715e>// For `HikariConfig`.</span>
</span></span><span style=display:flex><span>		registry.<span style=color:#a6e22e>add</span>(<span style=color:#e6db74>&#34;datasources.datasource-one.password&#34;</span>, databaseOne::getPassword);
</span></span><span style=display:flex><span>		registry.<span style=color:#a6e22e>add</span>(<span style=color:#e6db74>&#34;datasources.datasource-one.username&#34;</span>, databaseOne::getUsername);
</span></span><span style=display:flex><span>		registry.<span style=color:#a6e22e>add</span>(<span style=color:#e6db74>&#34;datasources.datasource-two.url&#34;</span>, databaseTwo::getJdbcUrl);
</span></span><span style=display:flex><span>		registry.<span style=color:#a6e22e>add</span>(<span style=color:#e6db74>&#34;datasources.datasource-two.jdbcUrl&#34;</span>, databaseTwo::getJdbcUrl); <span style=color:#75715e>// For `HikariConfig`.</span>
</span></span><span style=display:flex><span>		registry.<span style=color:#a6e22e>add</span>(<span style=color:#e6db74>&#34;datasources.datasource-two.password&#34;</span>, databaseTwo::getPassword);
</span></span><span style=display:flex><span>		registry.<span style=color:#a6e22e>add</span>(<span style=color:#e6db74>&#34;datasources.datasource-two.username&#34;</span>, databaseTwo::getUsername);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Qualifier</span>(<span style=color:#e6db74>&#34;dataSourceOne&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> DataSource one;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Qualifier</span>(<span style=color:#e6db74>&#34;dataSourceTwo&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> DataSource two;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>void</span> <span style=color:#a6e22e>canUseBothDataSources</span>() <span style=color:#66d9ef>throws</span> SQLException {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>try</span> (
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>var</span> connOne <span style=color:#f92672>=</span> one.<span style=color:#a6e22e>getConnection</span>();
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>var</span> connTwo <span style=color:#f92672>=</span> two.<span style=color:#a6e22e>getConnection</span>();
</span></span><span style=display:flex><span>		) {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>boolean</span> oneSucceeded <span style=color:#f92672>=</span> connOne.<span style=color:#a6e22e>createStatement</span>().<span style=color:#a6e22e>execute</span>(<span style=color:#e6db74>&#34;SELECT 1;&#34;</span>);
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>boolean</span> twoSucceeded <span style=color:#f92672>=</span> connTwo.<span style=color:#a6e22e>createStatement</span>().<span style=color:#a6e22e>execute</span>(<span style=color:#e6db74>&#34;SELECT 1;&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			assertThat(oneSucceeded).<span style=color:#a6e22e>isTrue</span>();
</span></span><span style=display:flex><span>			assertThat(twoSucceeded).<span style=color:#a6e22e>isTrue</span>();
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>void</span> <span style=color:#a6e22e>dataSourceOneConfiguredCorrectly</span>() {
</span></span><span style=display:flex><span>		assertThat(one).<span style=color:#a6e22e>isInstanceOfSatisfying</span>(HikariDataSource.<span style=color:#a6e22e>class</span>, hikariDataSource <span style=color:#f92672>-&gt;</span> {
</span></span><span style=display:flex><span>			assertThat(hikariDataSource.<span style=color:#a6e22e>getPoolName</span>()).<span style=color:#a6e22e>isEqualTo</span>(<span style=color:#e6db74>&#34;one&#34;</span>);
</span></span><span style=display:flex><span>			assertThat(hikariDataSource.<span style=color:#a6e22e>getConnectionTimeout</span>()).<span style=color:#a6e22e>isEqualTo</span>(30001);
</span></span><span style=display:flex><span>			assertThat(hikariDataSource.<span style=color:#a6e22e>getIdleTimeout</span>()).<span style=color:#a6e22e>isEqualTo</span>(600001);
</span></span><span style=display:flex><span>			assertThat(hikariDataSource.<span style=color:#a6e22e>getMaxLifetime</span>()).<span style=color:#a6e22e>isEqualTo</span>(1800001);
</span></span><span style=display:flex><span>		});
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>void</span> <span style=color:#a6e22e>dataSourceTwoConfiguredCorrectly</span>() {
</span></span><span style=display:flex><span>		assertThat(two).<span style=color:#a6e22e>isInstanceOfSatisfying</span>(HikariDataSource.<span style=color:#a6e22e>class</span>, hikariDataSource <span style=color:#f92672>-&gt;</span> {
</span></span><span style=display:flex><span>			assertThat(hikariDataSource.<span style=color:#a6e22e>getPoolName</span>()).<span style=color:#a6e22e>isEqualTo</span>(<span style=color:#e6db74>&#34;two&#34;</span>);
</span></span><span style=display:flex><span>			assertThat(hikariDataSource.<span style=color:#a6e22e>getConnectionTimeout</span>()).<span style=color:#a6e22e>isEqualTo</span>(30001);
</span></span><span style=display:flex><span>			assertThat(hikariDataSource.<span style=color:#a6e22e>getIdleTimeout</span>()).<span style=color:#a6e22e>isEqualTo</span>(600001);
</span></span><span style=display:flex><span>			assertThat(hikariDataSource.<span style=color:#a6e22e>getMaxLifetime</span>()).<span style=color:#a6e22e>isEqualTo</span>(1800001);
</span></span><span style=display:flex><span>		});
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>You can see it checks for general ability to use the <code>DataSource</code> instances and their individual configuration. Here, both the values from the shared &ldquo;base&rdquo; config as well as individual settings, represented by the <code>poolName</code> property, are being asserted on.</p><h3 id=solution-a-making-use-of-hikariconfig>Solution A: Making use of <code>HikariConfig</code></h3><p>We can frame this as the &ldquo;programmatic&rdquo; solution because it relies on certain configuration classes exposed through Hikari&rsquo;s API.</p><h4 id=externalized-configuration>Externalized Configuration</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># file: application-prog.yaml</span>
</span></span><span style=display:flex><span><span style=color:#f92672>datasources</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>hikari-base</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>connectionTimeout</span>: <span style=color:#ae81ff>30001</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>idleTimeout</span>: <span style=color:#ae81ff>600001</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>maxLifetime</span>: <span style=color:#ae81ff>1800001</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>datasource-one</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>username</span>: <span style=color:#e6db74>&#34;username-set-dynamically-in-test&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>password</span>: <span style=color:#e6db74>&#34;password-set-dynamically-in-test&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>jdbcUrl</span>: <span style=color:#e6db74>&#34;url-set-dynamically-in-test&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>poolName</span>: <span style=color:#e6db74>&#34;one&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>datasource-two</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>username</span>: <span style=color:#e6db74>&#34;username-set-dynamically-in-test&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>password</span>: <span style=color:#e6db74>&#34;password-set-dynamically-in-test&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>jdbcUrl</span>: <span style=color:#e6db74>&#34;url-set-dynamically-in-test&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>poolName</span>: <span style=color:#e6db74>&#34;two&#34;</span>
</span></span></code></pre></div><h4 id=configuration-class><code>@Configuration</code> class</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Profile</span>(<span style=color:#e6db74>&#34;prog&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Configuration</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@EnableConfigurationProperties</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ProgrammaticDataSourceConfiguration</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span>(<span style=color:#e6db74>&#34;hikariConfigBase&#34;</span>) <span style=color:#75715e>// (1)</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ConfigurationProperties</span>(<span style=color:#e6db74>&#34;datasources.hikari-base&#34;</span>)
</span></span><span style=display:flex><span>    HikariConfig <span style=color:#a6e22e>hikariBaseConfig</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> HikariConfig();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span>(<span style=color:#e6db74>&#34;hikariConfigOne&#34;</span>) <span style=color:#75715e>// (2)</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ConfigurationProperties</span>(<span style=color:#e6db74>&#34;datasources.datasource-one&#34;</span>)
</span></span><span style=display:flex><span>    HikariConfig <span style=color:#a6e22e>hikariConfigOne</span>(<span style=color:#a6e22e>@Qualifier</span>(<span style=color:#e6db74>&#34;hikariConfigBase&#34;</span>) HikariConfig hikariConfigBase) {
</span></span><span style=display:flex><span>        HikariConfig compositeConfig <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HikariConfig();
</span></span><span style=display:flex><span>        hikariConfigBase.<span style=color:#a6e22e>copyStateTo</span>(compositeConfig);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> compositeConfig;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span>(<span style=color:#e6db74>&#34;dataSourceOne&#34;</span>) <span style=color:#75715e>// (3)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> HikariDataSource <span style=color:#a6e22e>dataSourceOne</span>(<span style=color:#a6e22e>@Qualifier</span>(<span style=color:#e6db74>&#34;hikariConfigOne&#34;</span>) HikariConfig hikariConfigOne) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> HikariDataSource(hikariConfigOne);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span>(<span style=color:#e6db74>&#34;hikariConfigTwo&#34;</span>) <span style=color:#75715e>// (2)</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ConfigurationProperties</span>(<span style=color:#e6db74>&#34;datasources.datasource-two&#34;</span>)
</span></span><span style=display:flex><span>    HikariConfig <span style=color:#a6e22e>hikariConfigTwo</span>(<span style=color:#a6e22e>@Qualifier</span>(<span style=color:#e6db74>&#34;hikariConfigBase&#34;</span>) HikariConfig hikariConfigBase) {
</span></span><span style=display:flex><span>        HikariConfig compositeConfig <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HikariConfig();
</span></span><span style=display:flex><span>        hikariConfigBase.<span style=color:#a6e22e>copyStateTo</span>(compositeConfig);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> compositeConfig;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span>(<span style=color:#e6db74>&#34;dataSourceTwo&#34;</span>) <span style=color:#75715e>// (3)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> HikariDataSource <span style=color:#a6e22e>dataSourceTwo</span>(<span style=color:#a6e22e>@Qualifier</span>(<span style=color:#e6db74>&#34;hikariConfigTwo&#34;</span>) HikariConfig hikariConfigTwo) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> HikariDataSource(hikariConfigTwo);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Let&rsquo;s walk through it (look for comments containing steps&rsquo; ordinals):</p><ol><li>Expose &ldquo;base&rdquo; config as a bean. Hikari offers <code>HikariConfig</code> as a config class to use with <code>@ConfigurationProperties</code>.</li><li>&ldquo;Enhance&rdquo; config from step 1 with data source-specific settings. This is achieved by creating a new <code>HikariConfig</code> instance for each data source that contains the old values. Luckily, we can use <code>HikariConfig</code>&rsquo;s own API method <code>c.z.h.HikariConfig#copyStateTo</code> for that. <code>@ConfigurationProperties</code> then takes care of binding the <code>datasources-datasource-...</code> properties to the new instance.</li><li>Use configs from step 2 to create the final <code>HikariDataSource</code>s.</li></ol><p>Note:</p><ul><li><code>HikariConfig</code> binds to <code>jdbcUrl</code>, not <code>url</code>.</li><li>We cannot skip step 2 and use <code>@ConfigurationProperties("datasources-datasource-...")</code> in the <code>HikariDataSource</code> factory methods directly: When instantiating the data source with <code>new HikariDataSource(hikariConfig)</code> we&rsquo;d need the url. The url, however, will only be set <em>after</em> the instance exists.</li></ul><h3 id=solution-b-i-using-yaml-anchors>Solution B I: Using YAML anchors</h3><p>This is one of the two solutions based on <a href=https://support.atlassian.com/bitbucket-cloud/docs/yaml-anchors/>YAML anchors</a>, so it&rsquo;ll work only if the externalized configuration is a .yaml properties file.</p><h4 id=externalized-configuration-1>Externalized Configuration</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># file: application-yaml-simple.yaml</span>
</span></span><span style=display:flex><span><span style=color:#f92672>datasources</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>hikari-base</span>: <span style=color:#75715e>&amp;hikari-base</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>connectionTimeout</span>: <span style=color:#ae81ff>30001</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>idleTimeout</span>: <span style=color:#ae81ff>600001</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>maxLifetime</span>: <span style=color:#ae81ff>1800001</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>datasource-one</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>username</span>: <span style=color:#e6db74>&#34;username-set-dynamically-in-test&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>password</span>: <span style=color:#e6db74>&#34;password-set-dynamically-in-test&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>jdbcUrl</span>: <span style=color:#e6db74>&#34;url-set-dynamically-in-test&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;&lt;</span>: <span style=color:#75715e>*hikari-base</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>poolName</span>: <span style=color:#e6db74>&#34;one&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>datasource-two</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>username</span>: <span style=color:#e6db74>&#34;username-set-dynamically-in-test&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>password</span>: <span style=color:#e6db74>&#34;password-set-dynamically-in-test&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>jdbcUrl</span>: <span style=color:#e6db74>&#34;url-set-dynamically-in-test&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;&lt;</span>: <span style=color:#75715e>*hikari-base</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>poolName</span>: <span style=color:#e6db74>&#34;two&#34;</span>
</span></span></code></pre></div><h4 id=configuration-class-1><code>@Configuration</code> class</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Profile</span>(<span style=color:#e6db74>&#34;yaml-simple&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Configuration</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@EnableConfigurationProperties</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SimpleYamlAnchorDataSourceConfiguration</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span>(<span style=color:#e6db74>&#34;dataSourceOneProperties&#34;</span>) <span style=color:#75715e>// (1)</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ConfigurationProperties</span>(<span style=color:#e6db74>&#34;datasources.datasource-one&#34;</span>)
</span></span><span style=display:flex><span>    HikariConfig <span style=color:#a6e22e>dataSourceOneProperties</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> HikariConfig();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span>(<span style=color:#e6db74>&#34;dataSourceOne&#34;</span>) <span style=color:#75715e>// (2)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> HikariDataSource <span style=color:#a6e22e>dataSourceOne</span>(
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>@Qualifier</span>(<span style=color:#e6db74>&#34;dataSourceOneProperties&#34;</span>) HikariConfig dataSourceOneProperties
</span></span><span style=display:flex><span>    ) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> HikariDataSource(dataSourceOneProperties);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span>(<span style=color:#e6db74>&#34;dataSourceTwoProperties&#34;</span>) <span style=color:#75715e>// (1)</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ConfigurationProperties</span>(<span style=color:#e6db74>&#34;datasources.datasource-two&#34;</span>)
</span></span><span style=display:flex><span>    HikariConfig <span style=color:#a6e22e>dataSourceTwoProperties</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> HikariConfig();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span>(<span style=color:#e6db74>&#34;dataSourceTwo&#34;</span>) <span style=color:#75715e>// (2)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> HikariDataSource <span style=color:#a6e22e>dataSourceTwo</span>(
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>@Qualifier</span>(<span style=color:#e6db74>&#34;dataSourceTwoProperties&#34;</span>) HikariConfig dataSourceTwoProperties
</span></span><span style=display:flex><span>    ) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> HikariDataSource(dataSourceTwoProperties);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Like with the aforementioned solution, let&rsquo;s walk through this one, too:</p><ol><li>Bind the <code>datasources.datasource-...</code>-prefixed blocks via <code>@ConfigurationProperties</code> to <code>HikariConfig</code> instances, the latter being more or less a bean intended for mapping data source-related configuration onto it with some additional helper methods for constructing a <code>DataSource</code>.</li><li>Use the the <code>HikariConfig</code> of every declared data source section to create the actual <code>HikariDataSource</code> from it.</li></ol><h3 id=solution-b-ii-using-yaml-anchors>Solution B II: Using YAML anchors</h3><p>This is the other solution based on YAML anchors. It comes with a different properties structure, but essentially works the same.</p><h4 id=externalized-configuration-2>Externalized Configuration</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># file: application-yaml-structured.yaml</span>
</span></span><span style=display:flex><span><span style=color:#f92672>datasources</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>hikari-base</span>: <span style=color:#75715e>&amp;hikari-base</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>connectionTimeout</span>: <span style=color:#ae81ff>30001</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>idleTimeout</span>: <span style=color:#ae81ff>600001</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>maxLifetime</span>: <span style=color:#ae81ff>1800001</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>datasource-one</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>username</span>: <span style=color:#e6db74>&#34;username-set-dynamically-in-test&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>password</span>: <span style=color:#e6db74>&#34;password-set-dynamically-in-test&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>url</span>: <span style=color:#e6db74>&#34;url-set-dynamically-in-test&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>hikari</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;&lt;</span>: <span style=color:#75715e>*hikari-base</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>poolName</span>: <span style=color:#e6db74>&#34;one&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>datasource-two</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>username</span>: <span style=color:#e6db74>&#34;username-set-dynamically-in-test&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>password</span>: <span style=color:#e6db74>&#34;password-set-dynamically-in-test&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>url</span>: <span style=color:#e6db74>&#34;url-set-dynamically-in-test&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>hikari</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;&lt;</span>: <span style=color:#75715e>*hikari-base</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>poolName</span>: <span style=color:#e6db74>&#34;two&#34;</span>
</span></span></code></pre></div><h4 id=configuration-class-2><code>@Configuration</code> class</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Profile</span>(<span style=color:#e6db74>&#34;yaml-structured&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Configuration</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@EnableConfigurationProperties</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>StructuredYamlAnchorDataSourceConfiguration</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span>(<span style=color:#e6db74>&#34;dataSourceOneProperties&#34;</span>) <span style=color:#75715e>// (1)</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ConfigurationProperties</span>(<span style=color:#e6db74>&#34;datasources.datasource-one&#34;</span>)
</span></span><span style=display:flex><span>    DataSourceProperties <span style=color:#a6e22e>dataSourceOneProperties</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> DataSourceProperties();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span>(<span style=color:#e6db74>&#34;dataSourceOne&#34;</span>) <span style=color:#75715e>// (2)</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ConfigurationProperties</span>(<span style=color:#e6db74>&#34;datasources.datasource-one.hikari&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> HikariDataSource <span style=color:#a6e22e>dataSourceOne</span>(
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>@Qualifier</span>(<span style=color:#e6db74>&#34;dataSourceOneProperties&#34;</span>) DataSourceProperties dataSourceOneProperties
</span></span><span style=display:flex><span>    ) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> dataSourceOneProperties.<span style=color:#a6e22e>initializeDataSourceBuilder</span>().<span style=color:#a6e22e>type</span>(HikariDataSource.<span style=color:#a6e22e>class</span>).<span style=color:#a6e22e>build</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span>(<span style=color:#e6db74>&#34;dataSourceTwoProperties&#34;</span>) <span style=color:#75715e>// (1)</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ConfigurationProperties</span>(<span style=color:#e6db74>&#34;datasources.datasource-two&#34;</span>)
</span></span><span style=display:flex><span>    DataSourceProperties <span style=color:#a6e22e>dataSourceTwoProperties</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> DataSourceProperties();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span>(<span style=color:#e6db74>&#34;dataSourceTwo&#34;</span>) <span style=color:#75715e>// (2)</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ConfigurationProperties</span>(<span style=color:#e6db74>&#34;datasources.datasource-two.hikari&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> HikariDataSource <span style=color:#a6e22e>dataSourceTwo</span>(
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>@Qualifier</span>(<span style=color:#e6db74>&#34;dataSourceTwoProperties&#34;</span>) DataSourceProperties dataSourceTwoProperties
</span></span><span style=display:flex><span>    ) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> dataSourceTwoProperties.<span style=color:#a6e22e>initializeDataSourceBuilder</span>().<span style=color:#a6e22e>type</span>(HikariDataSource.<span style=color:#a6e22e>class</span>).<span style=color:#a6e22e>build</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The steps are essentially the same as with B I, but there&rsquo;s a bit more properties binding involved:</p><ol><li>Bind the <code>DataSource</code>-based properties of the <code>datasources.datasource-...</code>-prefixed blocks via <code>@ConfigurationProperties</code> to <code>DataSource</code> instances.</li><li>From the <code>DataSourceProperties</code> instances create <code>HikariDataSource</code>s by using Spring Boot&rsquo;s &ldquo;translation&rdquo;/building mechanism, which e.g. transfers <code>DataSource#url</code> to <code>HikariConfig#jdbcUrl</code>. The <code>datasources.datasource-....hikari</code> properties then get bound by way of <code>@ConfigurationProperties</code> to the new <code>HikariDataSource</code>s.</li></ol><p>Note:</p><ul><li>The binding in step 2 hinges on the fact that we don&rsquo;t need the properties declared under <code>datasources.datasource-....hikari</code> to create the <code>HikariDataSource</code> instances, but can set them following their instantiation.</li></ul><h2 id=evaluation>Evaluation</h2><p>We <em>did</em> land on B II, using YAML anchors with a &ldquo;structured&rdquo; externalized configuration for the following reasons:</p><ul><li>The externalized configuration of every data source reflects the way you would declare a single Hikari data source, i.e. <code>spring.datasource</code> with the <code>url</code>, <code>username</code>, and <code>password</code> properties; <code>spring.datasource.hikari</code> with Hikari-related properties.</li><li>The <code>@Configuration</code> providing the <code>DataSource</code> beans is relatively straightforward (yet not as simple as in B I), and doesn&rsquo;t have to make use of <code>HikariConfig</code>&rsquo;s programmatic API.</li></ul><p>Depending on how many Hikari-related properties you have, one might also prefer the &ldquo;simple&rdquo; YAML-anchor-based solution over the &ldquo;structured&rdquo; one. The demo <em>does</em> use very few Hikari-related properties and seems to suggest B I; our real world use case favors B II.</p><p>Moreover, as I hope to have demonstrated here, YAML anchors are a general solution to &ldquo;shared&rdquo; properties without having to resort to <code>${...}</code> property placeholder syntax.</p><p>But, and those are big &ldquo;but"s (and I cannot lie):</p><ol><li>Don&rsquo;t overdo the YAML abuse. It might turn simple externalized property declarations into complex code. You wouldn&rsquo;t want to have that.</li><li>If you can&rsquo;t declare your properties in YAML, solutions B I and II are out of the question anyways.</li></ol><hr>© Roman Böhm 2021 - 2024 &ndash; <a href=https://github.com/romanboehm>Github</a> &ndash;
<a rel=me href=https://mastodon.social/@romanboehm>Mastodon</a> &ndash; <a href=https://www.linkedin.com/in/%F0%9F%96%A5%EF%B8%8F-roman-b%C3%B6hm-837946175/>LinkedIn</a></body></html>