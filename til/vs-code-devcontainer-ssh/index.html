<!doctype html><html lang=en><head><meta charset=utf-8><meta name=description content="Personal website of Roman Böhm. Includes blog posts, shorter 'Today I learned' posts, and various personal information."><meta name=viewport content="width=device-width,initial-scale=1"><link href=/css/stylesheet.css rel=stylesheet><title>Roman Böhm - Frictionless SSH for VS Code Dev Containers on MacOS</title></head><body><h1>Roman Böhm</h1><nav><ul class=menu><li><a href=/>Home</a></li><li><a href=/posts/>Posts</a></li><li><a href=/til/>TIL</a></li><li><a href=/tags/>Tags</a></li><li><a href=/about/>About</a></li><li><a href=/index.xml><img src=/images/rss.svg alt="RSS icon" width=14em></a></li></ul></nav><hr><h1>Frictionless SSH for VS Code Dev Containers on MacOS</h1><h2>2023-06-30</h2><b><a href=/tags/vscode>vscode</a></b>
<b><a href=/tags/ssh>ssh</a></b>
<b><a href=/tags/macos>macos</a></b><h2 id=introduction>Introduction</h2><p>I wanted to write down how I got a frictionless SSH setup for <a href=https://code.visualstudio.com/docs/devcontainers/containers>VS Code Dev Containers</a> on MacOS where I have the necessary keys available, but don&rsquo;t need to manually unlock them anymore. I can e.g. simply push to GitHub/pull from GitHub from my dev environment inside the container.</p><h2 id=setup>Setup</h2><h3 id=ssh-keys>SSH Key(s)</h3><p>I usually create a separate SSH key pair for every use case. That means my <code>~/.ssh</code> dir contains a dedicated key for GitHub, which I&rsquo;ll use as an example in the remainder of the post:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>~ ls -1 .ssh/*github*
</span></span><span style=display:flex><span>.ssh/id-github-ed25519
</span></span><span style=display:flex><span>.ssh/id-github-ed25519.pub
</span></span></code></pre></div><p>The private key is also secured by a passphrase.</p><h3 id=macos-keychain-and-ssh-agent>MacOS Keychain and SSH Agent</h3><p>The VS Code Dev Containers extension facilitates SSH by automatically &ldquo;forwarding&rdquo; (for lack of a better word) the host system&rsquo;s SSH Agent to the Dev Container. Now, this means that integrating the Mac OS keychain and the SSH Agent will allow us to skip entering the passphrase when using the private key <em>inside</em> the container. This is done by two commands:</p><p>First, we need to add the private key to MacOS&rsquo; keychain (a.k.a. <em>Keychain Access.app</em>):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>ssh-add --apple-use-keychain ~/.ssh/id-github-ed25519
</span></span></code></pre></div><p>(The <code>--apple-use-keychain</code> and its <code>--apple-load-keychain</code> sibling are <em>relatively</em> new options to <code>ssh-add</code>, but they should be available to you unless you&rsquo;re lagging behind several major MacOS releases.)</p><p>This step will do two things: It will</p><ol><li>add the key to <code>ssh-agent</code> (verify with <code>ssh-add -l</code>), and</li><li>store the key&rsquo;s passphrase in the user&rsquo;s keychain.</li></ol><p>The latter means it will also unlock your key automatically once you&rsquo;ve successfully logged in your operating system user.</p><p>Unfortunately, this command does not persist accross reboots. So, secondly, we need to help the SSH Agent here by adding the following line to our <code>.zshrc</code> or <code>.bashrc</code> or whatever-is-doing-bootstrapping file:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>ssh-add --apple-load-keychain &amp;&gt; /dev/null
</span></span></code></pre></div><h3 id=vs-code>VS Code</h3><p>With this setup, there&rsquo;s <em>nothing</em> left to configure in VS Code itself, esp. in your <code>devcontainer.json</code> config file. Open your workspace in your container and interact with whatever remote destination your SSH key is designated for.</p><p>Note: You may move the <code>ssh-add ...</code> commands directly into <code>devcontainer.json</code>&rsquo;s <code>"initializeCommand"</code> option. I didn&rsquo;t want to do that, however, since it would make my container Apple-specific. This goes against my philosphy of keeping Dev Containers OS-agnostic. I very much expect to have whatever OS I&rsquo;m using configured to make the SSH keys available to the SSH Agent abstraction, not VS Code look for the keys itself.</p><hr>© Roman Böhm 2021 - 2023 &ndash; <a href=https://github.com/romanboehm>Github</a> &ndash;
<a rel=me href=https://mastodon.social/@romanboehm>Mastodon</a> &ndash; <a href=https://www.linkedin.com/in/%F0%9F%96%A5%EF%B8%8F-roman-b%C3%B6hm-837946175/>LinkedIn</a></body></html>