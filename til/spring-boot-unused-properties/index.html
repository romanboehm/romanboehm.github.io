<!doctype html><html lang=en><head><meta charset=utf-8><meta name=description content="Personal website of Roman Böhm. Includes blog posts, shorter 'Today I learned' posts, and various personal information."><meta name=viewport content="width=device-width,initial-scale=1"><link href=/css/stylesheet.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.5/purify.min.js integrity="sha512-KqUc2WMPF/gxte9xVjVE4TIt1LMUTidO3BrcItFg0Ro24I7pGNzgcXdnWdezNY+8T0/JEmdC79MuwYn+8UdOqw==" crossorigin=anonymous referrerpolicy=no-referrer></script><script src=/js/mastodon-comments.js></script><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css><title>Roman Böhm - Programmatically find unused properties in a Spring Boot app</title></head><body><h1>Roman Böhm</h1><nav><ul class=menu><li><a href=/>Home</a></li><li><a href=/posts/>Posts</a></li><li><a href=/til/>TIL</a></li><li><a href=/tags/>Tags</a></li><li><a href=/about/>About</a></li><li><a href=/index.xml><img src=/images/rss.svg alt="RSS icon" width=14em></a></li></ul></nav><hr><h1>Programmatically find unused properties in a Spring Boot app</h1><h2>2024-06-20</h2><b><a href=/tags/spring-boot>spring-boot</a></b>
<b><a href=/tags/spring>spring</a></b><h2 id=problem>Problem</h2><p><a href=https://docs.spring.io/spring-boot/reference/features/external-config.html>Spring Boot&rsquo;s externalized configuration</a> is a powerful feature. But with great power comes, ahem, at least sometimes, a bunch of unused properties polluting your environment. That <code>what=where-does-this-get-used</code> in <code>application-doineedthem.properties</code>? You might be able to remove it.</p><h2 id=solution>Solution</h2><p>I created a solution that you can incorporate into your test setup, so</p><ol><li>you get a failing build if you have unused properties (in a linter kind of way), and</li><li>you do not pollute your regular classpath with code related to meta topics such as unused properties.</li></ol><p>First, create an <code>EnvironmentPostProcessor</code>, which &ldquo;[a]llows for customization of the application&rsquo;s Environment prior to the application context being refreshed.&rdquo; This should be the correct time to <em>snapshot</em> your properties and inject property-usage tracking capabilities.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>UnusedPropertiesEnvironmentPostProcessor</span> <span style=color:#66d9ef>implements</span> EnvironmentPostProcessor {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> Set<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>getAllPropertyNames</span>(ConfigurableEnvironment environment) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> result <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HashSet<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>var</span> ps : environment.<span style=color:#a6e22e>getPropertySources</span>()) {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// One can pick one&#39;s own heuristic on what to track. </span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// `instance of OriginTrackedMapPropertySource` should cover externalized config files</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// such as application.properties.</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (ps <span style=color:#66d9ef>instanceof</span> OriginTrackedMapPropertySource otps) {
</span></span><span style=display:flex><span>                result.<span style=color:#a6e22e>addAll</span>(Arrays.<span style=color:#a6e22e>asList</span>(otps.<span style=color:#a6e22e>getPropertyNames</span>()));
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> result;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>postProcessEnvironment</span>(ConfigurableEnvironment environment, SpringApplication application) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> propertyNames <span style=color:#f92672>=</span> getAllPropertyNames(environment);
</span></span><span style=display:flex><span>        environment.<span style=color:#a6e22e>getPropertySources</span>().<span style=color:#a6e22e>addFirst</span>(<span style=color:#66d9ef>new</span> PropertySource<span style=color:#f92672>&lt;&gt;</span>(<span style=color:#e6db74>&#34;Usage tracking property source adapter&#34;</span>) {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> Object <span style=color:#a6e22e>getProperty</span>(String name) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> (<span style=color:#e6db74>&#34;unused.properties&#34;</span>.<span style=color:#a6e22e>equals</span>(name)) {
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>return</span> propertyNames;
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                propertyNames.<span style=color:#a6e22e>remove</span>(name);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Essentially, we&rsquo;re adding a dummy <code>PropertySource</code> instance that gets consulted <em>before</em> all the others. For every <code>getProperty(String name)</code> invocation, it will simply mark that property as used, i.e. remove it from the set of all previously detected properties, and, by returning <code>null</code>, will let the next <code>PropertySource</code> instance in line handle the call.</p><p>Whenever one retrieves the value of the <code>unused.properties</code> property, one gets the set of the properties that haven&rsquo;t been used anywhere until this point in time.</p><p>Next, create a <code>spring.factories</code> file under <code>src/test/resources/META-INF</code> with the following content to bootstrap the above <code>EnvironmentPostProcessor</code> instance:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>org.springframework.boot.env.EnvironmentPostProcessor=\
</span></span><span style=display:flex><span>  replace.with.your.package.UnusedPropertiesEnvironmentPostProcessor
</span></span></code></pre></div><p>Finally, we can use our detection mechanism in a <code>@SpringBootTest</code> like so:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@SpringBootTest</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>UnusedPropertiesTest</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Value</span>(<span style=color:#e6db74>&#34;${unused.properties}&#34;</span>)
</span></span><span style=display:flex><span>  Set<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> unusedProperties;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>containsNoUnusedProperties</span>() {
</span></span><span style=display:flex><span>    assertThat(unusedProperties).<span style=color:#a6e22e>isEmpty</span>();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>If you have e.g. a property <code>foo=bar</code> in your <code>application.properties</code> that you do not <code>@Value("${foo}")</code> anywhere, this test is going to fail.</p><mastodon-comments host=mastodon.social user=romanboehm tootid=112650692876985992></mastodon-comments><hr>© Roman Böhm 2021 - 2024 &ndash; <a href=https://github.com/romanboehm>Github</a> &ndash;
<a rel=me href=https://mastodon.social/@romanboehm>Mastodon</a> &ndash; <a href=https://www.linkedin.com/in/%F0%9F%96%A5%EF%B8%8F-roman-b%C3%B6hm-837946175/>LinkedIn</a></body></html>